# 5. Cartridge Controller Integration - Dojo Game Starter

## üéÆ What is Cartridge Controller?

Cartridge Controller is a **gaming-focused wallet** built specifically for onchain games on Starknet. Unlike traditional wallets that require constant popups and confirmations, the Controller provides a seamless gaming experience through **session policies** that pre-approve specific game actions.

```
üéØ Gaming Wallet vs Traditional Wallet

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TRADITIONAL WALLET                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Each Action ‚Üí Popup ‚Üí User Approval ‚Üí Transaction             ‚îÇ
‚îÇ  üèãÔ∏è Train ‚Üí üì± "Approve?" ‚Üí ‚úÖ Click ‚Üí ‚è≥ Wait                   ‚îÇ
‚îÇ  ‚õèÔ∏è Mine  ‚Üí üì± "Approve?" ‚Üí ‚úÖ Click ‚Üí ‚è≥ Wait                   ‚îÇ
‚îÇ  üí§ Rest  ‚Üí üì± "Approve?" ‚Üí ‚úÖ Click ‚Üí ‚è≥ Wait                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Result: Interrupted gameplay, poor UX                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CARTRIDGE CONTROLLER                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Pre-approved Actions ‚Üí Direct Execution ‚Üí Instant Feedback    ‚îÇ
‚îÇ  üèãÔ∏è Train ‚Üí ‚ö° Instant ‚Üí ‚úÖ +10 EXP                             ‚îÇ
‚îÇ  ‚õèÔ∏è Mine  ‚Üí ‚ö° Instant ‚Üí ‚úÖ +5 Coins, -5 HP                     ‚îÇ
‚îÇ  üí§ Rest  ‚Üí ‚ö° Instant ‚Üí ‚úÖ +20 HP                              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Result: Seamless gameplay, console-like UX                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Controller Configuration

### **`cartridgeConnector.tsx`** - The Heart of Gaming UX

The Cartridge Connector configuration is where the magic happens - defining which actions players can perform without constant wallet popups:

```typescript
import { Connector } from "@starknet-react/core";
import { ControllerConnector } from "@cartridge/connector";
import { ColorMode, SessionPolicies, ControllerOptions } from "@cartridge/controller";
import { constants } from "starknet";

const { VITE_PUBLIC_DEPLOY_TYPE } = import.meta.env;

// Your deployed game contract address
const CONTRACT_ADDRESS_GAME = '0x31b119987eeb1a6c0d13b029ad9a3c64856369dcdfd6e69d9af4c9fba6f507f';

// üéØ SESSION POLICIES - The key to seamless gaming
const policies: SessionPolicies = {
  contracts: {
    [CONTRACT_ADDRESS_GAME]: {
      methods: [
        { name: "spawn_player", entrypoint: "spawn_player" },
        { name: "train", entrypoint: "train" },
        { name: "mine", entrypoint: "mine" },
        { name: "rest", entrypoint: "rest" },
      ],
    },
  },
};

// üé® VISUAL CUSTOMIZATION
const colorMode: ColorMode = "dark";                    // Dark theme for gaming
const theme = "full-starter-react";                     // Custom game theme

const options: ControllerOptions = {
  // üåê Network Configuration
  chains: [
    {
      rpcUrl: "https://api.cartridge.gg/x/starknet/sepolia",
    },
  ],
  defaultChainId: VITE_PUBLIC_DEPLOY_TYPE === 'mainnet'
    ? constants.StarknetChainId.SN_MAIN
    : constants.StarknetChainId.SN_SEPOLIA,

  // üéØ Core Configuration
  policies,                                              // Pre-approved actions
  theme,                                                 // Visual branding
  colorMode,                                             // UI appearance
  namespace: "full_starter_react",                       // Unique game identifier
  slot: "full-starter-react",                           // Session slot name
};

// Create the connector instance
const cartridgeConnector = new ControllerConnector(options) as never as Connector;

export default cartridgeConnector;
```

---

## üîë Session Policies - The Core Innovation

**Session Policies** are what make Cartridge Controller revolutionary for gaming. They define exactly which contract methods can be called without user approval.

### **Policy Structure Breakdown**

```typescript
const policies: SessionPolicies = {
  contracts: {
    // Contract address (from your deployed Dojo contracts)
    [CONTRACT_ADDRESS_GAME]: {
      methods: [
        // Each method that should work seamlessly in-game
        { name: "spawn_player", entrypoint: "spawn_player" },     // Create new player
        { name: "train", entrypoint: "train" },                   // +10 EXP action
        { name: "mine", entrypoint: "mine" },                     // +5 coins, -5 health
        { name: "rest", entrypoint: "rest" },                     // +20 health recovery
      ],
    },
  },
};
```

### **üéØ Why This Matters:**

```typescript
// ‚ùå WITHOUT Session Policies (traditional wallet):
const train = async () => {
  // User sees popup: "Do you want to approve this transaction?"
  const approval = await wallet.requestPermission("train");
  if (approval) {
    const tx = await contract.train();
    // User waits, game flow interrupted
  }
  // Poor gaming experience
};

// ‚úÖ WITH Session Policies (Cartridge Controller):
const train = async () => {
  const tx = await client.game.train(account);
  // Executes immediately, no popup, seamless experience
  updatePlayerExperience(+10); // Optimistic update
  // Perfect gaming UX
};
```

### **üõ°Ô∏è Security & Limitations**

Session policies are **secure by design**:

- **Contract-specific**: Only approved contracts can be called
- **Method-specific**: Only approved methods within those contracts
- **Time-limited**: Sessions expire and need renewal
- **Revocable**: Users can revoke permissions anytime

```typescript
// ‚úÖ ALLOWED - These will execute seamlessly
await client.game.train(account);        // Pre-approved ‚úÖ
await client.game.mine(account);         // Pre-approved ‚úÖ
await client.game.rest(account);         // Pre-approved ‚úÖ

// ‚ùå BLOCKED - These will require explicit approval
await client.game.deletePlayer(account); // Not in policies ‚ùå
await otherContract.transfer(account);    // Different contract ‚ùå
```

---

## üåê Network & Environment Configuration

### **Multi-Environment Support**

```typescript
const options: ControllerOptions = {
  chains: [
    {
      // Cartridge provides optimized RPC endpoints
      rpcUrl: "https://api.cartridge.gg/x/starknet/sepolia",
    },
  ],

  // Automatic network selection based on deployment
  defaultChainId: VITE_PUBLIC_DEPLOY_TYPE === 'mainnet'
    ? constants.StarknetChainId.SN_MAIN      // Mainnet for production
    : constants.StarknetChainId.SN_SEPOLIA,  // Sepolia for testing

  namespace: "full_starter_react",           // Unique identifier
  slot: "full-starter-react",               // Session storage key
};
```

### **üîß Environment Variables**

```bash
# .env.local
VITE_PUBLIC_DEPLOY_TYPE=sepolia              # or 'mainnet'
```

This automatically switches between networks without code changes!

---

## üé® Visual Customization

### **Gaming-First UI Design**

```typescript
// Visual configuration for gaming experience
const colorMode: ColorMode = "dark";        // Perfect for gaming
const theme = "full-starter-react";         // Your game's branding

const options: ControllerOptions = {
  colorMode,                                 // Dark theme
  theme,                                     // Custom styling
  // ... other options
};
```

### **üéÆ Controller Features**

- **Dark Mode**: Optimized for gaming sessions
- **Custom Themes**: Brand your wallet experience
- **Achievement Integration**: Built-in achievement system
- **Profile Management**: Player profiles and statistics
- **Session Management**: Clear session status and controls

---

## üîå Integration with React Hooks

### **`useStarknetConnect.tsx`** - Connection Management

The Controller integrates seamlessly with Starknet React hooks:

```typescript
export function useStarknetConnect() {
  const { connect, connectors } = useConnect();
  const { disconnect } = useDisconnect();
  const { status, address } = useAccount();
  const [isConnecting, setIsConnecting] = useState(false);

  const handleConnect = useCallback(async () => {
    const connector = connectors[0]; // Cartridge Controller
    if (!connector) {
      console.error("No connector found");
      return;
    }

    try {
      setIsConnecting(true);
      console.log("üîó Attempting to connect controller...");

      // This opens the Cartridge Controller interface
      await connect({ connector });

      console.log("‚úÖ Controller connected successfully");
    } catch (error) {
      console.error("‚ùå Connection failed:", error);
    } finally {
      setIsConnecting(false);
    }
  }, [connect, connectors]);

  return {
    status,           // 'connected' | 'disconnected' | 'connecting'
    address,          // Player's wallet address
    isConnecting,     // Loading state
    handleConnect,    // Function to open Controller
    handleDisconnect, // Function to disconnect
  };
}
```

### **üéÆ Connection Flow**

```
1. User clicks "Connect Controller"
   ‚Üì
2. Cartridge Controller interface opens
   ‚Üì
3. User creates account or signs in
   ‚Üì
4. Session policies are approved
   ‚Üì
5. Game actions now work seamlessly
   ‚Üì
6. Player can focus on gameplay!
```

---

## üéØ Advanced Controller Features

### **Profile Integration**

The Controller provides built-in profile management:

```typescript
// Access to controller-specific features
const { connector } = useAccount();

const handlePlayerReady = useCallback(() => {
  if (!connector || !('controller' in connector)) {
    console.error("Connector not initialized");
    return;
  }

  // Open player profile with achievements
  if (connector.controller && 'openProfile' in connector.controller) {
    connector.controller.openProfile("achievements");
  }
}, [connector]);
```

### **üèÜ Built-in Achievement System**

```typescript
// Achievement integration comes built-in
const openAchievements = () => {
  connector.controller.openProfile("achievements");
};

```

---

## üîÑ Integration with StarknetProvider

### **Provider Configuration**

```typescript
// starknet-provider.tsx
export default function StarknetProvider({ children }: PropsWithChildren) {
  return (
    <StarknetConfig
      autoConnect                                    // Auto-reconnect on page load
      chains={[sepolia]}                            // Available networks
      connectors={[cartridgeConnector]}             // Use Cartridge Controller
      provider={provider}                           // RPC provider
    >
      {children}
    </StarknetConfig>
  );
}
```

### **üîÑ Auto-Connection Flow**

```typescript
// Automatic reconnection on page load
useEffect(() => {
  if (isConnected && !player && !isInitializing) {
    console.log("üéÆ Controller connected, auto-initializing player...");

    // Automatically create player if needed
    setTimeout(() => {
      initializePlayer().then(result => {
        console.log("üéÆ Auto-initialization result:", result);
      });
    }, 500);
  }
}, [isConnected, player, isInitializing, initializePlayer]);
```

---

## üöÄ Game Action Flow with Controller

### **Seamless Transaction Pattern**

```typescript
// Game action with Controller (no popups!)
const executeTrain = useCallback(async () => {
  try {
    // 1. ‚ö° Optimistic update (instant UI feedback)
    updatePlayerExperience((player?.experience || 0) + 10);

    // 2. üéÆ Execute via Controller (no popup)
    console.log("üì§ Executing train transaction...");
    const tx = await client.game.train(account); // Seamless!

    // 3. ‚úÖ Handle confirmation
    if (tx && tx.code === "SUCCESS") {
      console.log("‚úÖ Train successful!");
      // UI already updated optimistically
    }

  } catch (error) {
    // 4. ‚ùå Rollback on error
    updatePlayerExperience((player?.experience || 0) - 10);
    console.error("‚ùå Training failed:", error);
  }
}, [client, account, player, updatePlayerExperience]);
```

### **üéØ User Experience Comparison**

```
Traditional Wallet Flow:
User clicks "Train" ‚Üí Popup appears ‚Üí User clicks "Approve" ‚Üí Transaction processes ‚Üí UI updates
‚è±Ô∏è Time: 5-10 seconds, requires user attention

Controller Flow:
User clicks "Train" ‚Üí UI updates instantly ‚Üí Transaction processes in background
‚è±Ô∏è Time: <1 second, no interruption
```

---

## üéÆ Gaming UX Benefits

### **Why Controller is Perfect for Onchain Games**

| Traditional Wallet | Cartridge Controller | Impact |
|-------------------|---------------------|---------|
| Popup per action | Pre-approved actions | üöÄ **10x faster** gameplay |
| User attention required | Background execution | üéØ **Uninterrupted** focus |
| Complex UI | Gaming-focused design | üòä **Better** user experience |
| Generic branding | Custom game themes | üé® **Branded** experience |
| No achievements | Built-in achievement system | üèÜ **Enhanced** engagement |

---

The Cartridge Controller transforms blockchain gaming from a friction-filled experience into something that feels like traditional gaming. By eliminating constant wallet popups and providing gaming-specific features, it enables developers to create truly engaging onchain games.

**Next**: We'll explore the [**React Hooks Pattern**](./06-react-hooks-pattern.md) that powers the seamless integration between Controller, Dojo contracts, and React components.
